{#
  TAG PICTURE PER IMMAGINI DA VIEWER
  ===================================

  {%- include '@includes/imgs_viewer.html.twig' with {
    img: img_obj,
    alt: 'xxxx',
    sizes: {
      xl: {w: 1440, h: xxx},
      lg: {w: 1199, h: xxx},
      md: {w:  991, h: xxx},
      sm: {w:  767, h: xxx},
      xs: {w:  575, h: xxx}
    },
    lqip: null, // low quality img placeholder
    class: 'img-fluid',
    lazyload: true // facoltativo, default true,
    attrs: null // attributi extra facoltativi
  } -%}


  dove:
    img = {             <== oggetto file std
      id     : 123,
      width  : 1000,
      height : 900,
      mime   : 'image/jpeg'
    }

    sizes = {                  <== array breakpoint -> bounding box (NB: da xl a xs)
      xl: {w: 1000, h: null},  <== equivale a `bb=1000x`
         lg: {},               <== eventuali breakpoints non necessari devono essere omessi
      md: {w: null, h: null},  <== equivale a omettere il parametro bb
      sm: {...},
      xs: {...}
    }

#}

{#

<picture>
  <source type="image/webp" srcset="img-xl.webp" media="(min-width: 1200px)">
  <source srcset="img-xl.jpg" media="(min-width: 1200px)">

  <source type="image/webp" srcset="img-lg.webp" media="(min-width: 992px) and (max-width: 1199px)">
  <source srcset="img-lg.jpg" media="(min-width: 992px) and (max-width: 1199px)">

  <source type="image/webp" srcset="img-md.webp" media="(min-width: 768px) and (max-width: 991px)">
  <source srcset="img-md.jpg" media="(min-width: 768px) and (max-width: 991px)">

  <source type="image/webp" srcset="img-sm.webp" media="(min-width: 576px) and (max-width: 767px)">
  <source srcset="img-sm.jpg" media="(min-width: 576px) and (max-width: 767px)">

  <source type="image/webp" srcset="img-xs.webp">
  <img src="img-xs.jpg" alt="Testata Luci" class="img-fluid d-block object-fix-cover">
</picture>
#}

{%- set img_base_url = url_esterni.shared_apps ~ '/viewer/' ~ img.id -%}
{% set alt = alt is defined? alt : '' %}
{% set lazyload = lazyload is defined? lazyload : true %}
{% set class = class is defined ? class : '' %}
{% set lqip = lqip is defined ? lqip : null %}

{%- if lazyload and not ('lazyload' in class) -%}
	{% set class = class ~ ' lazyload' %}
{%- endif -%}

{% set mediaqueries = glob_vars.mq|merge(glob_vars.special_mq) %}

<picture>
  {%- for breakpoint, bb in sizes -%}

    {% set last_breakpoint = loop.last %}

  	{%- for formato in ['webp', 'default'] -%}
      {%- set f_param = [] -%}

  		{%- if formato == 'webp' and not ('webp' in img.mime) -%}
        {%- set f_param = ['f=webp'] -%}

  		{%- elseif formato == 'default' and ('webp' in img.mime) -%}
        {%- set f_param = ['f=pjpeg'] -%}

  		{%- endif -%}

  		{% set srcset = [] %}

  		{% for densita in 1..3 if not (breakpoint in ['xl','lg','md', 'md_xl', 'md_lg', 'lg_xl'] and densita == 3 ) %}

        {% set this_width =  (bb.w is defined and bb.w is not null)?  bb.w * densita : null %}
        {% set this_height = (bb.h is defined and bb.h is not null)?  bb.h * densita : null %}

        {% if densita == 1 or (this_width and img.width >= this_width) or (this_height and img.height >= this_height) %}
          {%- set this_size_params = [] -%}

          {%- if this_width is not null or this_height is not null  -%}
            {%- set this_size_params = this_size_params|merge([
              'bb=' ~ (this_width? this_width : '') ~ 'x' ~ (this_height? this_height : '')
            ]) -%}
          {%- endif -%}

          {%- if this_width is not null and this_height is not null  -%}
            {%- set this_size_params = this_size_params|merge(['fd=1']) -%}
          {%- endif -%}

          {%- set tot_params = []|merge(this_size_params)|merge(f_param) -%}
          {% set std_img = img_base_url ~ (tot_params|length? '?' ~ tot_params|join('&') : '') %}

          {% set srcset = srcset|merge([std_img ~ (densita > 1 ? " #{densita}x" : '')]) %}
        {% endif %} {# end densita == 1 or (this_width and this_width >= img.width ... #}
      {%- endfor -%} {# end for densita #}

      {%- if last_breakpoint and formato == 'default' -%}

        <img
          {{- (lazyload and (not lqip))? ' data-' : ' ' -}} src="{{ lqip? lqip : srcset[0] }}"
          {{- lazyload? ' data-' : ' ' -}} srcset="{{ srcset|slice(1)|join(', ') }}"
          {{- ' ' -}} alt="{{ alt }}"
          {%- if class %} class="{{ class }}"{% endif %}
          {%- if test %} data-brkp="{{ breakpoint }}"{% endif -%}
          {%- if attrs|default() %} {{ attrs|raw }}{% endif -%}>

      {%- else -%}

        <source
          {{- lazyload? ' data-' : ' ' -}} srcset="{{ srcset|join(', ') }}"
          {%- if formato == 'webp' %} type="image/webp"{% endif -%}
          {{- ' ' -}} media="{{ mediaqueries[breakpoint] }}"
          {%- if test %} data-brkp="{{ breakpoint }}"{% endif %}>

      {%- endif -%}

  	{%- endfor -%} {# end for breakpoint #}
  {%- endfor -%}
</picture>
